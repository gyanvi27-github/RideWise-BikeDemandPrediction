name: Deploy to Streamlit Cloud

# Trigger: Run on push to main branch
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  create-secrets:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3
      
      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      # Step 3: Create .streamlit directory
      - name: Create .streamlit directory
        run: |
          mkdir -p .streamlit
          echo "ğŸ“ Created .streamlit directory"
      
      # Step 4: Create secrets.toml with GitHub secrets
      - name: Create secrets.toml
        run: |
          cat > .streamlit/secrets.toml << EOF
          [nvidia]
          api_key = "${{ secrets.NVIDIA_API_KEY }}"
          base_url = "${{ secrets.NVIDIA_BASE_URL }}"
          EOF
          echo "âœ… secrets.toml created successfully"
      
      # Step 5: Verify secrets file (without exposing content)
      - name: Verify secrets file
        run: |
          if [ -f .streamlit/secrets.toml ]; then
            echo "âœ… secrets.toml exists"
            echo "ğŸ“„ File size: $(wc -c < .streamlit/secrets.toml) bytes"
          else
            echo "âŒ secrets.toml not found!"
            exit 1
          fi
      
      # Step 6: Install dependencies (optional - for testing)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install streamlit
          echo "âœ… Dependencies installed"
      
      # Step 7: Test import (optional - verify no errors)
      - name: Test app imports
        run: |
          python -c "import streamlit; print('âœ… Streamlit imported successfully')"
      
      # Step 8: Display success message
      - name: Deployment ready
        run: |
          echo "ğŸ‰ =================================="
          echo "ğŸ‰ Secrets configured successfully!"
          echo "ğŸ‰ =================================="
          echo ""
          echo "ğŸ“‹ Next steps:"
          echo "1. Your code will automatically use these secrets"
          echo "2. Streamlit Cloud will also need secrets configured separately"
          echo "3. For local development, create .streamlit/secrets.toml manually"
